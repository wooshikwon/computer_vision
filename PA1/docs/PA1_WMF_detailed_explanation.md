# Weighted Median Filter ì™„ì „ ì´í•´ ê°€ì´ë“œ

## ëª©ì°¨
1. [ë¬¸ì œ ìƒí™©: ì™œ í•„ìš”í•œê°€?](#1-ë¬¸ì œ-ìƒí™©-ì™œ-í•„ìš”í•œê°€)
2. [Median Filter ê¸°ì´ˆ](#2-median-filter-ê¸°ì´ˆ)
3. [Weighted Medianì´ë€?](#3-weighted-medianì´ë€)
4. [Guide ì´ë¯¸ì§€ì˜ ì—­í• ](#4-guide-ì´ë¯¸ì§€ì˜-ì—­í• )
5. [ê°€ì¤‘ì¹˜ ê³„ì‚° ë°©ë²•](#5-ê°€ì¤‘ì¹˜-ê³„ì‚°-ë°©ë²•)
6. [Weighted Median ê³„ì‚° ì•Œê³ ë¦¬ì¦˜](#6-weighted-median-ê³„ì‚°-ì•Œê³ ë¦¬ì¦˜)
7. [PA1ì—ì„œì˜ ì ìš©](#7-pa1ì—ì„œì˜-ì ìš©)
8. [ì‹¤ì „ ì˜ˆì‹œ](#8-ì‹¤ì „-ì˜ˆì‹œ)
9. [ì™œ Outlier ì œê±°ì— íš¨ê³¼ì ì¸ê°€?](#9-ì™œ-outlier-ì œê±°ì—-íš¨ê³¼ì ì¸ê°€)

---

## 1. ë¬¸ì œ ìƒí™©: ì™œ í•„ìš”í•œê°€?

### 1.1 Disparity Mapì˜ ë¬¸ì œì 

Disparity selection (winner-takes-all) í›„ì—ë„ ì—¬ì „íˆ **ë…¸ì´ì¦ˆ**ì™€ **ì´ìƒì¹˜(outlier)**ê°€ ì¡´ì¬í•©ë‹ˆë‹¤:

```
ì´ìƒì ì¸ disparity map:
  ë¬¼ì²´: 50 50 50 50 50
  ë°°ê²½: 10 10 10 10 10

ì‹¤ì œ disparity map:
  ë¬¼ì²´: 50 50 [3] 50 50    â† ì¤‘ê°„ì— outlier!
  ë°°ê²½: 10 [45] 10 10 10   â† ì¤‘ê°„ì— outlier!
```

**ì›ì¸:**
- Textureless ì˜ì—­ (í…ìŠ¤ì²˜ ì—†ëŠ” ë²½, í•˜ëŠ˜)
- Occlusion (ê°€ë ¤ì§„ ì˜ì—­)
- ë°˜ë³µ íŒ¨í„´ (repetitive texture)
- ë…¸ì´ì¦ˆ (ì„¼ì„œ ë…¸ì´ì¦ˆ, ì¡°ëª… ë³€í™”)

### 1.2 ê¸°ì¡´ í•„í„°ì˜ í•œê³„

**Mean Filter (í‰ê· ):**
```python
ê°’: [50, 50, 3, 50, 50]
í‰ê· : (50+50+3+50+50) / 5 = 40.6
      â†‘ Outlier 3ì´ í‰ê· ì„ í¬ê²Œ ì™œê³¡!
```

**Gaussian Filter:**
```python
# ê°€ì¤‘ í‰ê· ì´ì§€ë§Œ ì—¬ì „íˆ outlier ì˜í–¥
ê°€ì¤‘ í‰ê· : 50Ã—0.2 + 50Ã—0.2 + 3Ã—0.2 + 50Ã—0.2 + 50Ã—0.2 = 40.6
```

**ë¬¸ì œ**: Outlierì— **ë¯¼ê°**

### 1.3 í•´ê²°ì±…: Median Filter

```python
ê°’: [50, 50, 3, 50, 50]
ì •ë ¬: [3, 50, 50, 50, 50]
ì¤‘ê°„ê°’:       â†‘ 50
      â†‘ Outlier ë¬´ì‹œ!
```

**ì¥ì **: Outlierì— **ê°•ê±´(robust)**

í•˜ì§€ë§Œ ë‹¨ìˆœ medianì€ **ê²½ê³„ë¥¼ ë¬´ì‹œ**í•©ë‹ˆë‹¤. â†’ **Weighted Median** í•„ìš”!

---

## 2. Median Filter ê¸°ì´ˆ

### 2.1 Medianì´ë€?

**ì •ì˜**: ê°’ë“¤ì„ ì •ë ¬í–ˆì„ ë•Œ **ì¤‘ê°„ì— ìœ„ì¹˜í•œ ê°’**

```
í™€ìˆ˜ ê°œ: [1, 3, 5, 7, 9]
        ì •ë ¬:    [1, 3, 5, 7, 9]
        Median:       â†‘ 5

ì§ìˆ˜ ê°œ: [1, 3, 5, 7]
        ì •ë ¬: [1, 3, 5, 7]
        Median:    â†‘â†‘ (3+5)/2 = 4
```

### 2.2 Median Filter ë™ì‘

**3Ã—3 Median Filter:**
```
ì´ë¯¸ì§€:
  10  10  10
  10 [X] 10    â† X ìœ„ì¹˜ í•„í„°ë§
  10  10 100

ì£¼ë³€ 9ê°œ ê°’: [10, 10, 10, 10, X, 10, 10, 10, 100]
ì •ë ¬: [10, 10, 10, 10, 10, 10, 10, X, 100]
Median:                      â†‘ 10

ê²°ê³¼: 10 (outlier 100 ë¬´ì‹œ!)
```

### 2.3 Median vs Mean

**ì˜ˆì‹œ: Salt-and-pepper noise**
```
ì›ë³¸:  10  10  10  10  10
ë…¸ì´ì¦ˆ: 10 255  10 255  10

Mean Filter:
(10+255+10+255+10) / 5 = 108  â† ì—‰ë§

Median Filter:
ì •ë ¬: [10, 10, 10, 255, 255]
Median:       â†‘ 10  â† ì •í™•!
```

### 2.4 Median Filterì˜ í•œê³„

```
ë¬¼ì²´ A (d=50) | ë°°ê²½ B (d=10)
â”â”â”â”â”â”â”â”â”â”â”â”â”ƒâ”â”â”â”â”â”â”â”â”â”â”â”
           ê²½ê³„

ê²½ê³„ í”½ì…€ì—ì„œ 3Ã—3 median:
ê°’: [50, 50, 50, 50, X, 10, 10, 10, 10]
ì •ë ¬: [10, 10, 10, 10, 50, 50, 50, 50, X]
Median:                â†‘ 50 ë˜ëŠ” 10 (ë¶ˆì•ˆì •)

ë¬¸ì œ: ê²½ê³„ë¥¼ ë¬´ì‹œí•˜ê³  ëª¨ë“  ê°’ ì„ìŒ
```

**í•´ê²°ì±…**: ê²½ê³„ ì •ë³´ë¥¼ ê³ ë ¤ â†’ **Weighted Median**

---

## 3. Weighted Medianì´ë€?

### 3.1 ì •ì˜

**Weighted Median**: ê° ê°’ì— **ê°€ì¤‘ì¹˜**ë¥¼ ë¶€ì—¬í•˜ì—¬ ê³„ì‚°í•œ ì¤‘ê°„ê°’

```
ì¼ë°˜ Median: ëª¨ë“  ê°’ì´ ë™ë“±
Weighted Median: ì¤‘ìš”í•œ ê°’ì— ë” í° ì˜í–¥
```

### 3.2 ê°œë…

**ì˜ˆì‹œ:**
```
ê°’:      [10, 20, 30]
ê°€ì¤‘ì¹˜:  [1,  1,  1]   â† ëª¨ë‘ ë™ë“±

í™•ì¥:    [10, 20, 30]
       = [10 Ã—1, 20 Ã—1, 30 Ã—1]
       = [10, 20, 30]
Median: 20
```

**ê°€ì¤‘ì¹˜ ë¶€ì—¬:**
```
ê°’:      [10, 20, 30]
ê°€ì¤‘ì¹˜:  [0.1, 0.7, 0.2]  â† 20ì— ë†’ì€ ê°€ì¤‘ì¹˜

ê°œë…ì ìœ¼ë¡œ:
10ì´ 10% ì¤‘ìš”
20ì´ 70% ì¤‘ìš”  â† ê°€ì¥ ì¤‘ìš”!
30ì´ 20% ì¤‘ìš”

Weighted Median: 20
(ê°€ì¤‘ì¹˜ê°€ ë†’ì€ 20ì´ ì„ íƒë¨)
```

### 3.3 Weighted Median ê³„ì‚° ë°©ë²•

**ì•Œê³ ë¦¬ì¦˜:**
1. ê°’ë“¤ì„ ì •ë ¬
2. ê°€ì¤‘ì¹˜ì˜ **ëˆ„ì í•©(cumulative sum)** ê³„ì‚°
3. ëˆ„ì í•©ì´ **ì „ì²´ì˜ 50%**ê°€ ë˜ëŠ” ì§€ì ì˜ ê°’ ì„ íƒ

**ì˜ˆì‹œ:**
```
ê°’:          [10, 20, 30, 40]
ê°€ì¤‘ì¹˜:      [0.1, 0.3, 0.4, 0.2]

Step 1: ê°’ìœ¼ë¡œ ì •ë ¬ (ì´ë¯¸ ì •ë ¬ë¨)
Step 2: ëˆ„ì  ê°€ì¤‘ì¹˜
  10: 0.1        (10%)
  20: 0.1+0.3=0.4 (40%)
  30: 0.4+0.4=0.8 (80%)  â† 50% ë„˜ëŠ” ì²« ì§€ì 
  40: 0.8+0.2=1.0 (100%)

Step 3: 50% ì§€ì  = 0.5
  0.5ëŠ” 0.4ì™€ 0.8 ì‚¬ì´
  â†’ Weighted Median = 30
```

---

## 4. Guide ì´ë¯¸ì§€ì˜ ì—­í• 

### 4.1 Weighted Median Filterì—ì„œì˜ Guide

**Joint Bilateral Filterì™€ ê°™ì€ ì›ë¦¬:**
- Filtering ëŒ€ìƒ: Disparity map
- Guide: ì›ë³¸ left ì´ë¯¸ì§€
- Guideë¡œ ê°€ì¤‘ì¹˜ ê³„ì‚°

```python
weighted_median_filter(
    disparity,    # í•„í„°ë§ ëŒ€ìƒ
    left_image    # Guide (ê²½ê³„ ì •ë³´)
)
```

### 4.2 Guideê°€ ê°€ì¤‘ì¹˜ë¥¼ ê²°ì •

```
Guide ì´ë¯¸ì§€:
  0.2  0.2  0.2 | 0.8  0.8  0.8
  0.2  0.2 [X] | 0.8  0.8  0.8   â† X=0.2
  0.2  0.2  0.2 | 0.8  0.8  0.8
  ë¬¼ì²´ A         | ë°°ê²½ B
               â†‘ ê²½ê³„

ê°€ì¤‘ì¹˜ (X=0.2 ê¸°ì¤€):
- ì™¼ìª½ í”½ì…€ (0.2): guide ê°’ ë¹„ìŠ· â†’ ê°€ì¤‘ì¹˜ ë†’ìŒ
- ì˜¤ë¥¸ìª½ í”½ì…€ (0.8): guide ê°’ ë‹¤ë¦„ â†’ ê°€ì¤‘ì¹˜ ë‚®ìŒ
```

**íš¨ê³¼**: ê°™ì€ ë¬¼ì²´ ë‚´ ê°’ë“¤ì´ median ê³„ì‚°ì— ë” í° ì˜í–¥

---

## 5. ê°€ì¤‘ì¹˜ ê³„ì‚° ë°©ë²•

### 5.1 Bilateral ê°€ì¤‘ì¹˜ ì¬ì‚¬ìš©

**Weighted Medianë„ Bilateral ë°©ì‹ ì‚¬ìš©:**
```python
weight = Gs Ã— Gr

Gs: ê³µê°„ ê°€ìš°ì‹œì•ˆ (ê±°ë¦¬ ê¸°ë°˜)
Gr: ë²”ìœ„ ê°€ìš°ì‹œì•ˆ (guide ê°’ ì°¨ì´ ê¸°ë°˜)
```

**Joint Bilateral Filterì™€ ë™ì¼!**

### 5.2 ê³µê°„ ê°€ìš°ì‹œì•ˆ (Gs)

```python
distance = âˆš((x-x')Â² + (y-y')Â²)
Gs = exp(-distanceÂ² / (2 Ã— sigma_sÂ²))
```

**ì˜ˆì‹œ (7Ã—7 window, sigma_s=3.0):**
```
ì¤‘ì‹¬ í”½ì…€ ê¸°ì¤€ ê±°ë¦¬:
  âˆš8  âˆš5  âˆš2  âˆš1   0  âˆš1  âˆš2
  âˆš5  âˆš2  âˆš1   0  âˆš1  âˆš2  âˆš5
  âˆš2  âˆš1   0  âˆš1  âˆš2  âˆš5  âˆš8
  âˆš1   0  âˆš1  âˆš2  âˆš5  âˆš8  âˆš13
   0  âˆš1  âˆš2  âˆš5  âˆš8  âˆš13 âˆš18
  ...

Gs (ê°€ì¤‘ì¹˜):
  0.14 0.24 0.61 0.78 1.0 0.78 0.61
  0.24 0.61 0.78 1.0 0.78 0.61 0.24
  ...
```

### 5.3 ë²”ìœ„ ê°€ìš°ì‹œì•ˆ (Gr)

```python
g_center = guide[y, x]
g_neighbor = guide[y', x']
value_diff = |g_center - g_neighbor|
Gr = exp(-value_diffÂ² / (2 Ã— sigma_rÂ²))
```

**ì˜ˆì‹œ (sigma_r=0.08):**
```
Guide ê°’:
  0.2  0.2  0.2 | 0.8  0.8
  0.2  0.2 [X] | 0.8  0.8   â† X=0.2
  0.2  0.2  0.2 | 0.8  0.8

ê°’ ì°¨ì´:
  0.0  0.0  0.0 | 0.6  0.6
  0.0  0.0 [0.0]| 0.6  0.6
  0.0  0.0  0.0 | 0.6  0.6

Gr (sigma_r=0.08):
  1.0  1.0  1.0 | ~0.0  ~0.0
  1.0  1.0 [1.0]| ~0.0  ~0.0
  1.0  1.0  1.0 | ~0.0  ~0.0
```

### 5.4 ìµœì¢… ê°€ì¤‘ì¹˜

```python
weight = Gs Ã— Gr

ê²½ê³„ ë‚´ (ì™¼ìª½, guide=0.2):
  Gs: ë†’ìŒ, Gr: ë†’ìŒ â†’ weight: ë†’ìŒ âœ…

ê²½ê³„ ë„˜ìŒ (ì˜¤ë¥¸ìª½, guide=0.8):
  Gs: ë†’ìŒ, Gr: ~0 â†’ weight: ~0 âŒ
```

---

## 6. Weighted Median ê³„ì‚° ì•Œê³ ë¦¬ì¦˜

### 6.1 ì „ì²´ ì•Œê³ ë¦¬ì¦˜

```python
def weighted_median(values, weights):
    """
    values: ì£¼ë³€ í”½ì…€ì˜ disparity ê°’ë“¤
    weights: ê° ê°’ì˜ ê°€ì¤‘ì¹˜
    """
    # Step 1: ê°’ìœ¼ë¡œ ì •ë ¬
    sorted_indices = np.argsort(values)
    sorted_values = values[sorted_indices]
    sorted_weights = weights[sorted_indices]

    # Step 2: ê°€ì¤‘ì¹˜ ëˆ„ì í•©
    cumsum = np.cumsum(sorted_weights)

    # Step 3: ì „ì²´ ê°€ì¤‘ì¹˜ì˜ 50% ì§€ì 
    total_weight = cumsum[-1]
    half_weight = total_weight * 0.5

    # Step 4: 50% ì§€ì ì˜ ê°’ ì°¾ê¸°
    idx = np.searchsorted(cumsum, half_weight)
    return sorted_values[idx]
```

### 6.2 ë‹¨ê³„ë³„ ì˜ˆì‹œ

**ì…ë ¥:**
```
Disparity ê°’: [50, 50, 3, 50, 50]  (ì¤‘ê°„ì— outlier)
ê°€ì¤‘ì¹˜:       [0.2, 0.3, 0.05, 0.3, 0.15]
```

**Step 1: ì •ë ¬**
```
ê°’:    [3, 50, 50, 50, 50]
ê°€ì¤‘ì¹˜: [0.05, 0.2, 0.3, 0.3, 0.15]
```

**Step 2: ëˆ„ì  ê°€ì¤‘ì¹˜**
```
ê°’:         [3,    50,   50,   50,   50]
ê°€ì¤‘ì¹˜:     [0.05, 0.2,  0.3,  0.3,  0.15]
ëˆ„ì  ê°€ì¤‘ì¹˜: [0.05, 0.25, 0.55, 0.85, 1.0]
            5%    25%   55%   85%   100%
```

**Step 3: 50% ì§€ì **
```
half_weight = 1.0 Ã— 0.5 = 0.5

ëˆ„ì  ê°€ì¤‘ì¹˜:
  0.05 (5%)   â† 50% ë¯¸ë§Œ
  0.25 (25%)  â† 50% ë¯¸ë§Œ
  0.55 (55%)  â† 50% ë„˜ëŠ” ì²« ì§€ì ! âœ…
  0.85 (85%)
  1.0  (100%)
```

**Step 4: ê²°ê³¼**
```
idx = 2 (0.55ê°€ ìˆëŠ” ì¸ë±ìŠ¤)
Weighted Median = sorted_values[2] = 50 âœ…

outlier 3ì€ ê°€ì¤‘ì¹˜ê°€ ë‚®ì•„ì„œ ë¬´ì‹œë¨!
```

### 6.3 ì¼ë°˜ Medianê³¼ ë¹„êµ

**ì¼ë°˜ Median:**
```
ê°’: [3, 50, 50, 50, 50]
Median:     â†‘ 50 (3ë²ˆì§¸ ê°’)
```

**Weighted Median (ê°€ì¤‘ì¹˜ ì—†ì´):**
```
ê°’:       [3,  50, 50, 50, 50]
ê°€ì¤‘ì¹˜:   [0.2, 0.2, 0.2, 0.2, 0.2]  â† ëª¨ë‘ ë™ë“±
ëˆ„ì :     [0.2, 0.4, 0.6, 0.8, 1.0]
50% ì§€ì :           â†‘ 0.6 (3ë²ˆì§¸)
Weighted Median: 50
```

**ê²°ê³¼**: ê°€ì¤‘ì¹˜ê°€ ë™ë“±í•˜ë©´ ì¼ë°˜ medianê³¼ ê°™ìŒ

---

## 7. PA1ì—ì„œì˜ ì ìš©

### 7.1 ì „ì²´ íë¦„

```
1. Disparity selection ì™„ë£Œ
   disp = select_disparity(agg_cost_vol)
   â†’ disp.shape = (H, W)

2. Weighted Median Filter ì ìš©
   disp_filtered = weighted_median_disparity_numpy(
       disp,        # í•„í„°ë§ ëŒ€ìƒ
       left,        # Guide
       win_radius=3,
       sigma_s=3.0,
       sigma_r=0.08
   )

3. ê²°ê³¼: ë¶€ë“œëŸ½ê³  outlier ì—†ëŠ” disparity map
```

### 7.2 ê° í”½ì…€ë§ˆë‹¤ ì ìš©

```python
for y in range(H):
    for x in range(W):
        # 1. ì£¼ë³€ 7Ã—7 ì˜ì—­ì˜ disparity ê°’ë“¤
        disp_patch = disp[y:y+7, x:x+7]  # 49ê°œ ê°’

        # 2. Guide ì´ë¯¸ì§€ ì°¸ê³ í•˜ì—¬ ê°€ì¤‘ì¹˜ ê³„ì‚°
        g_center = guide[y, x]
        guide_patch = guide[y:y+7, x:x+7]

        # 3. Bilateral ê°€ì¤‘ì¹˜
        Gs = spatial_gaussian(...)
        Gr = range_gaussian(guide_patch, g_center, ...)
        weights = Gs * Gr  # (7Ã—7)

        # 4. Weighted Median ê³„ì‚°
        wm = weighted_median(disp_patch, weights)

        # 5. ê²°ê³¼ ì €ì¥
        disp_filtered[y, x] = wm
```

### 7.3 êµ¬ì²´ì  ì˜ˆì‹œ

```
Disparity (ê²½ê³„ í”½ì…€ ì£¼ë³€ 3Ã—3):
  50  50  50
  50 [X] 10
  10  10  10

Guide (ì •ê·œí™”):
  0.2  0.2  0.2
  0.2 [X] 0.8
  0.8  0.8  0.8

X = (1, 1), guide=0.2

ê°€ì¤‘ì¹˜ ê³„ì‚°:
  Gs Ã— Gr:
    ë†’ìŒ ë†’ìŒ ë†’ìŒ
    ë†’ìŒ ìµœëŒ€ ë‚®ìŒ
    ë‚®ìŒ ë‚®ìŒ ë‚®ìŒ

Disparity + ê°€ì¤‘ì¹˜:
  ê°’:    [50, 50, 50, 50, X, 10, 10, 10, 10]
  ê°€ì¤‘ì¹˜: [0.8, 0.8, 0.8, 0.8, 1.0, 0.01, 0.01, 0.01, 0.01]

ì •ë ¬ í›„:
  ê°’:    [10, 10, 10, 10, 50, 50, 50, 50, X]
  ê°€ì¤‘ì¹˜: [0.01, 0.01, 0.01, 0.01, 0.8, 0.8, 0.8, 0.8, 1.0]

ëˆ„ì  ê°€ì¤‘ì¹˜:
  [0.01, 0.02, 0.03, 0.04, 0.84, 1.64, 2.44, 3.24, 4.24]

ì „ì²´: 4.24
50%: 2.12
â†’ ëˆ„ì  2.44ê°€ ì²« ë²ˆì§¸ë¡œ 2.12 ë„˜ìŒ
â†’ Weighted Median = 50 âœ…

ë¬¼ì²´ Aì˜ disparity ìœ ì§€!
```

---

## 8. ì‹¤ì „ ì˜ˆì‹œ

### 8.1 Python ì½”ë“œ

```python
def weighted_median_disparity_numpy(disp, guide_gray,
                                     win_radius=3, sigma_s=3.0, sigma_r=0.1):
    disp = disp.astype(np.float32)
    guide = guide_gray.astype(np.float32) / 255.0  # 0-1 ì •ê·œí™”
    H, W = disp.shape
    out = np.zeros_like(disp)

    k = 2*win_radius + 1  # 7

    # 1. ê³µê°„ ê°€ìš°ì‹œì•ˆ ë¯¸ë¦¬ ê³„ì‚°
    ys, xs = np.mgrid[-win_radius:win_radius+1, -win_radius:win_radius+1]
    Gs = np.exp(-(xs**2 + ys**2) / (2 * sigma_s**2))

    # 2. Padding
    pad = win_radius
    d_p = np.pad(disp, pad, mode='reflect')
    g_p = np.pad(guide, pad, mode='reflect')

    # 3. ê° í”½ì…€ë§ˆë‹¤
    for y in range(H):
        for x in range(W):
            # 3.1 ì¤‘ì‹¬ guide ê°’
            g0 = g_p[y+pad, x+pad]

            # 3.2 ì£¼ë³€ íŒ¨ì¹˜
            d_patch = d_p[y:y+k, x:x+k]  # Disparity
            g_patch = g_p[y:y+k, x:x+k]  # Guide

            # 3.3 ë²”ìœ„ ê°€ìš°ì‹œì•ˆ
            Gr = np.exp(-((g_patch - g0)**2) / (2 * sigma_r**2))

            # 3.4 ìµœì¢… ê°€ì¤‘ì¹˜
            Wgt = (Gs * Gr).reshape(-1)  # 1Dë¡œ flatten
            Vals = d_patch.reshape(-1)

            # 3.5 Weighted Median ê³„ì‚°
            order = np.argsort(Vals)       # ì •ë ¬
            w_sorted = Wgt[order]          # ê°€ì¤‘ì¹˜ë„ ê°™ì€ ìˆœì„œ
            v_sorted = Vals[order]         # ì •ë ¬ëœ ê°’ë“¤

            csum = np.cumsum(w_sorted)     # ëˆ„ì í•©
            half = csum[-1] * 0.5          # 50% ì§€ì 
            idx = np.searchsorted(csum, half)  # 50% ì§€ì  ì¸ë±ìŠ¤

            # 3.6 ê²°ê³¼
            out[y, x] = v_sorted[min(idx, v_sorted.size-1)]

    return out
```

### 8.2 ë‹¨ê³„ë³„ ë””ë²„ê¹…

**í…ŒìŠ¤íŠ¸ ë°ì´í„°:**
```python
# ê°„ë‹¨í•œ 3Ã—3 ì˜ˆì‹œ
disp = np.array([
    [10, 10, 10],
    [10, 50, 10],  # ì¤‘ì‹¬ì´ outlier
    [10, 10, 10]
], dtype=np.float32)

guide = np.array([
    [0.1, 0.1, 0.1],
    [0.1, 0.1, 0.1],
    [0.1, 0.1, 0.1]
], dtype=np.float32)  # ëª¨ë‘ ê°™ì€ ì˜ì—­
```

**ì‹¤í–‰:**
```python
result = weighted_median_disparity_numpy(disp, guide*255,
                                          win_radius=1,
                                          sigma_s=1.0,
                                          sigma_r=0.1)

print(result[1, 1])  # ì¤‘ì‹¬ í”½ì…€
# ê¸°ëŒ€: 10 (outlier 50 ì œê±°ë¨)
```

**ë‚´ë¶€ ë™ì‘:**
```
ì¤‘ì‹¬ í”½ì…€ (1, 1):

Step 1: ì£¼ë³€ ê°’ë“¤
  [10, 10, 10, 10, 50, 10, 10, 10, 10]

Step 2: ê°€ì¤‘ì¹˜ (guide ëª¨ë‘ ë¹„ìŠ·í•˜ë¯€ë¡œ Grâ‰ˆ1)
  Gsë§Œ ì ìš©: [0.14, 0.61, 0.14, 0.61, 1.0, 0.61, 0.14, 0.61, 0.14]

Step 3: ì •ë ¬
  ê°’:    [10, 10, 10, 10, 10, 10, 10, 10, 50]
  ê°€ì¤‘ì¹˜: [0.14, 0.61, 0.14, 0.61, 0.61, 0.14, 0.61, 0.14, 1.0]

Step 4: ëˆ„ì  ê°€ì¤‘ì¹˜
  [0.14, 0.75, 0.89, 1.50, 2.11, 2.25, 2.86, 3.00, 4.00]

Step 5: 50% = 2.0
  â†’ idx = 4 (ëˆ„ì  2.11)
  â†’ Weighted Median = 10 âœ…

Outlier 50ì€ ê°€ì¤‘ì¹˜ê°€ ìˆì–´ë„ ë‹¤ìˆ˜ì˜ 10ì— ë°€ë¦¼!
```

---

## 9. ì™œ Outlier ì œê±°ì— íš¨ê³¼ì ì¸ê°€?

### 9.1 Medianì˜ ë³¸ì§ˆì  ê°•ê±´ì„±

**Mean vs Median:**
```
ì •ìƒ ê°’: [10, 10, 10, 10, 10]
Outlier ì¶”ê°€: [10, 10, 10, 10, 10, 100]

Mean:
  (10Ã—5 + 100) / 6 = 25  â† í¬ê²Œ ì™œê³¡

Median:
  ì •ë ¬: [10, 10, 10, 10, 10, 100]
  ì¤‘ê°„:          â†‘â†‘ (10+10)/2 = 10  â† ì •í™•!
```

**í•µì‹¬**: Medianì€ **ìˆœì„œ**ë§Œ ë³´ë¯€ë¡œ ê·¹ë‹¨ê°’ ì˜í–¥ ìµœì†Œ

### 9.2 Weighted Medianì˜ ì¶”ê°€ ì´ì 

**ì¼ë°˜ Median ë¬¸ì œ:**
```
ê²½ê³„ì—ì„œ:
  ë¬¼ì²´: [50, 50, 50, 50]
  ë°°ê²½: [10, 10, 10, 10, 10]

ì •ë ¬: [10, 10, 10, 10, 10, 50, 50, 50, 50]
Median:                â†‘ 10 (ë°°ê²½ ìª½ìœ¼ë¡œ ì¹˜ìš°ì¹¨)
```

**Weighted Median í•´ê²°:**
```
ê²½ê³„ í”½ì…€ì´ ë¬¼ì²´ ìª½ì´ë¼ë©´:
  ë¬¼ì²´ ê°’ë“¤: ê°€ì¤‘ì¹˜ ë†’ìŒ
  ë°°ê²½ ê°’ë“¤: ê°€ì¤‘ì¹˜ ë‚®ìŒ (guide ë‹¤ë¦„)

ê°’:      [10, 10, 10, 10, 10, 50, 50, 50, 50]
ê°€ì¤‘ì¹˜:  [0.01, 0.01, 0.01, 0.01, 0.01, 0.8, 0.8, 0.8, 0.8]

ëˆ„ì  ê°€ì¤‘ì¹˜:
  [0.01, 0.02, 0.03, 0.04, 0.05, 0.85, 1.65, 2.45, 3.25]

50% = 1.625
â†’ ëˆ„ì  1.65ê°€ ì²« 50% ë„˜ìŒ
â†’ Weighted Median = 50 âœ…

ë¬¼ì²´ì˜ disparity ë³´ì¡´!
```

### 9.3 ê²½ê³„ ë³´ì¡´ + Outlier ì œê±°

**Weighted Medianì˜ ì´ì¤‘ íš¨ê³¼:**

1. **ê²½ê³„ ë³´ì¡´** (Guide í™œìš©)
   - ê°™ì€ ë¬¼ì²´ ë‚´ ê°’ë“¤ë§Œ median ê³„ì‚°ì— ì°¸ì—¬
   - ë‹¤ë¥¸ ë¬¼ì²´ ê°’ì€ ê°€ì¤‘ì¹˜ ë‚®ì•„ì„œ ì˜í–¥ ìµœì†Œ

2. **Outlier ì œê±°** (Median ë³¸ì§ˆ)
   - ê·¹ë‹¨ê°’ì€ medianì— ì˜í–¥ ì—†ìŒ
   - ë‹¤ìˆ˜ì˜ ì •ìƒ ê°’ì´ median ê²°ì •

**ìµœê³ ì˜ ì¡°í•©!**

### 9.4 ì‹¤ì œ ì˜ˆì‹œ

**ìƒí™©: í…ìŠ¤ì²˜ ì—†ëŠ” ë²½ì— ë…¸ì´ì¦ˆ**
```
ì›ë³¸ disparity (ë²½, ì´ìƒì ìœ¼ë¡œëŠ” ëª¨ë‘ 30):
  30  30  30  30  30
  30  30  [5] 30  30  â† Outlier!
  30  30  30  30  30
  30  30  30  [60] 30  â† Outlier!
  30  30  30  30  30
```

**Box Filter (mean):**
```
ì¤‘ì‹¬ í”½ì…€ 3Ã—3 í‰ê· :
  (30Ã—8 + 5) / 9 = 27.2  â† ì™œê³¡
```

**ì¼ë°˜ Median Filter:**
```
ì¤‘ì‹¬ í”½ì…€ 3Ã—3 median:
  [5, 30, 30, 30, 30, 30, 30, 30, 30]
  Median:     â†‘ 30  â† ì •í™•! âœ…
```

**Weighted Median Filter:**
```
Guideê°€ ëª¨ë‘ ë¹„ìŠ· (ë²½) â†’ ê°€ì¤‘ì¹˜ ë¹„ìŠ·
ë™ì‘: ì¼ë°˜ medianê³¼ ìœ ì‚¬
ê²°ê³¼: 30 âœ…

ì¶”ê°€ ì´ì : ë²½ ê²½ê³„ì—ì„œë„ ë³´ì¡´
```

**ìƒí™©: ê²½ê³„ ê·¼ì²˜ outlier**
```
ë¬¼ì²´ (50) | ë°°ê²½ (10)
â”â”â”â”â”â”â”â”ƒâ”â”â”â”â”â”â”

ê²½ê³„ í”½ì…€ ì£¼ë³€:
  50  50  50
  50 [3] 10  â† Outlier 3
  10  10  10
```

**ì¼ë°˜ Median:**
```
ê°’: [3, 10, 10, 10, 10, 50, 50, 50, 50]
Median:                â†‘ 10 (ì˜ëª»ë¨)
```

**Weighted Median (ë¬¼ì²´ ìª½ í”½ì…€):**
```
Guide ì°¸ê³ :
  ë¬¼ì²´ ê°’ë“¤: ê°€ì¤‘ì¹˜ ë†’ìŒ
  ë°°ê²½ ê°’ë“¤: ê°€ì¤‘ì¹˜ ë‚®ìŒ

ê°’:     [3,    10,   10,   10,   10,   50,  50,  50,  50]
ê°€ì¤‘ì¹˜: [1.0,  0.01, 0.01, 0.01, 0.01, 0.8, 0.8, 0.8, 0.8]

Weighted Median: 50 âœ…

Outlier ì œê±° + ê²½ê³„ ë³´ì¡´!
```

---

## 10. ìš”ì•½

### 10.1 í•µì‹¬ ê°œë…

| ê°œë… | ì˜ë¯¸ |
|------|------|
| **Median** | ì •ë ¬ í›„ ì¤‘ê°„ ê°’ |
| **Weighted Median** | ê°€ì¤‘ì¹˜ ê³ ë ¤í•œ ì¤‘ê°„ ê°’ (ëˆ„ì  50% ì§€ì ) |
| **Guide ì´ë¯¸ì§€** | ê°€ì¤‘ì¹˜ ê³„ì‚°ì˜ ê¸°ì¤€ (ê²½ê³„ ì •ë³´) |
| **ê°€ì¤‘ì¹˜** | Gs Ã— Gr (ê±°ë¦¬ + guide ê°’ ì°¨ì´) |
| **íš¨ê³¼** | Outlier ì œê±° + ê²½ê³„ ë³´ì¡´ |

### 10.2 ì‘ë™ ì›ë¦¬

```
1. Disparity mapì— ë…¸ì´ì¦ˆ/outlier ì¡´ì¬
2. Guide (left ì´ë¯¸ì§€)ë¥¼ ì°¸ê³ í•˜ì—¬ ê°€ì¤‘ì¹˜ ê³„ì‚°
3. Guideì—ì„œ ë¹„ìŠ·í•œ ê°’ë¼ë¦¬ ë†’ì€ ê°€ì¤‘ì¹˜
4. Weighted medianìœ¼ë¡œ ì¤‘ì‹¬ ê°’ ê²°ì •
5. OutlierëŠ” ê°€ì¤‘ì¹˜ ë‚®ê±°ë‚˜ median ì›ë¦¬ë¡œ ë¬´ì‹œ
6. ê²°ê³¼: ë¶€ë“œëŸ½ê³  ê²½ê³„ ë³´ì¡´ëœ disparity map
```

### 10.3 PA1ì—ì„œì˜ íš¨ê³¼

**Box Filter:**
- ë¹ ë¦„ âš¡
- ê²½ê³„ íë ¤ì§ ğŸ˜¢
- Outlierì— ë¯¼ê° ğŸ˜¢

**Joint Bilateral Filter (TODO6):**
- ëŠë¦¼ ğŸ¢
- ê²½ê³„ ì„ ëª… âœ¨
- Outlierì—ëŠ” ì—¬ì „íˆ ì˜í–¥ ğŸ˜

**Weighted Median Filter (TODO7):**
- ë§¤ìš° ëŠë¦¼ ğŸŒ
- ê²½ê³„ ì„ ëª… âœ¨
- Outlier ì œê±° âœ¨âœ¨
- **ìµœê³  í’ˆì§ˆ!**

### 10.4 ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

**ê¸°ë³¸ ê³¼ì œ:**
- Box Filterë¡œ ì¶©ë¶„

**ê³ ê¸‰ ì ìˆ˜:**
- JBF + WMF ì¡°í•©
- JBFë¡œ ê²½ê³„ ë³´ì¡´
- WMFë¡œ outlier ì œê±° ë° ì¶”ê°€ smoothing

### 10.5 íŒŒë¼ë¯¸í„° ê°€ì´ë“œ

```python
# ê²½ê³„ ê°•í•˜ê²Œ ë³´ì¡´
sigma_r = 0.05  # ì‘ì€ ê°’

# Outlier ê°•í•˜ê²Œ ì œê±°
win_radius = 5  # í° window (ë” ë§ì€ ê°’ ì°¸ê³ )

# ì¶”ì²œ ì¡°í•© (PA1)
win_radius=3, sigma_s=3.0, sigma_r=0.08
```

---

## 11. ë§ˆì§€ë§‰ ì§ˆë¬¸ ë‹µë³€

### Q1: Weighted Medianì´ë€?
**A**: ê° ê°’ì— ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ê³„ì‚°í•œ ì¤‘ê°„ê°’. ê°€ì¤‘ì¹˜ ëˆ„ì í•©ì´ 50%ê°€ ë˜ëŠ” ì§€ì ì˜ ê°’.

### Q2: ì™œ Outlier ì œê±°ì— íš¨ê³¼ì ?
**A**: Medianì€ ê·¹ë‹¨ê°’ì— ê°•ê±´ + WeightedëŠ” ê²½ê³„ ê³ ë ¤ â†’ ì´ì¤‘ íš¨ê³¼!

### Q3: GuideëŠ” ì–´ë–»ê²Œ ì‚¬ìš©?
**A**: Guide ê°’ì´ ë¹„ìŠ·í•œ í”½ì…€ì— ë†’ì€ ê°€ì¤‘ì¹˜ â†’ ê°™ì€ ë¬¼ì²´ ë‚´ ê°’ë“¤ì´ median ê²°ì •.

### Q4: JBFì™€ì˜ ì°¨ì´ëŠ”?
**A**:
- JBF: ê°€ì¤‘ **í‰ê· ** (mean) â†’ ë¶€ë“œëŸ½ê²Œ
- WMF: ê°€ì¤‘ **ì¤‘ê°„ê°’** (median) â†’ outlier ì œê±°

### Q5: ë‘˜ ë‹¤ ì‚¬ìš©í•˜ëŠ” ì´ìœ ?
**A**:
- JBF: Cost aggregation ë‹¨ê³„ì—ì„œ ê²½ê³„ ë³´ì¡´
- WMF: Disparity refinement ë‹¨ê³„ì—ì„œ outlier ì œê±°
- ìƒí˜¸ ë³´ì™„ì !

---

**ì´ì œ Weighted Median Filterë¥¼ ì™„ì „íˆ ì´í•´í•˜ì…¨ë‚˜ìš”?** ğŸ¯
